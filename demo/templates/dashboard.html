{% extends "base.html" %}

{% block title %}AI Agent Prior Authorization Dashboard - Jarvus Demo{% endblock %}

{% block page_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% block content %}
<div class="work-queue-container">


    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="all">
            <i class="fas fa-list"></i>
            All Requests
            <span class="tab-count" id="all-count">0</span>
        </button>
        <button class="tab-button" data-tab="running">
            <i class="fas fa-play-circle"></i>
            In Progress
            <span class="tab-count" id="running-tab-count">0</span>
        </button>
        <button class="tab-button" data-tab="review">
            <i class="fas fa-eye"></i>
            Human Review
            <span class="tab-count" id="review-tab-count">0</span>
        </button>
        <button class="tab-button" data-tab="feedback">
            <i class="fas fa-question-circle"></i>
            Needs Input
            <span class="tab-count" id="feedback-tab-count">0</span>
        </button>
        <button class="tab-button" data-tab="completed">
            <i class="fas fa-check-circle"></i>
            Completed
            <span class="tab-count" id="completed-tab-count">0</span>
        </button>
    </div>

    <!-- Filter and Search Bar -->
    <div class="filter-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search by patient name, MRN, or service type...">
        </div>
        <div class="filter-controls">
            <select id="provider-filter">
                <option value="">All Payers</option>
                <option value="Original Medicare">Original Medicare</option>
                <option value="Humana Medicare Advantage">Humana Medicare Advantage</option>
                <option value="UnitedHealthcare Medicare Advantage">UnitedHealthcare Medicare Advantage</option>
                <option value="Aetna Medicare Advantage">Aetna Medicare Advantage</option>
                <option value="Kaiser Medicare Advantage">Kaiser Medicare Advantage</option>
                <option value="Anthem Medicare Advantage">Anthem Medicare Advantage</option>
                <option value="Cigna Medicare Advantage">Cigna Medicare Advantage</option>
                <option value="Blue Cross Medicare Advantage">Blue Cross Medicare Advantage</option>
            </select>
            <select id="step-filter">
                <option value="">All Steps</option>
                <option value="1">Step 1: Coverage Determination</option>
                <option value="2">Step 2: Requirements Extraction</option>
                <option value="3">Step 3: Screening</option>
                <option value="4">Step 4: Data Extraction</option>
                <option value="5">Step 5: Form Submission</option>
            </select>
            <button class="refresh-btn" onclick="loadData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Work Queue Table -->
    <div class="queue-table-container">
        <table class="queue-table" id="prior-auth-table">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th class="patient-col sortable" data-sort="patient_name">
                        Patient <i class="fas fa-sort"></i>
                    </th>
                    <th class="service-col sortable" data-sort="service_type">
                        Service Type <i class="fas fa-sort"></i>
                    </th>
                    <th class="cpt-col sortable" data-sort="cpt_code">
                        CPT Code <i class="fas fa-sort"></i>
                    </th>
                    <th class="insurance-col sortable" data-sort="insurance_provider">
                        Insurance <i class="fas fa-sort"></i>
                    </th>
                    <th class="progress-col">Progress</th>
                    <th class="current-step-col">Current Step</th>
                    <th class="status-col sortable" data-sort="status">
                        Status <i class="fas fa-sort"></i>
                    </th>
                    <th class="dates-col sortable" data-sort="created_date">
                        Created <i class="fas fa-sort"></i>
                    </th>
                    <th class="due-col sortable" data-sort="due_date">
                        Due <i class="fas fa-sort"></i>
                    </th>
                    <th class="actions-col">Actions</th>
                </tr>
            </thead>
            <tbody id="prior-auth-tbody">
                <!-- Data will be loaded dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulk-actions" style="display: none;">
        <div class="bulk-info">
            <span id="selected-count">0</span> items selected
        </div>
        <div class="bulk-buttons">
            <button class="btn btn-primary" onclick="startAutomation()">
                <i class="fas fa-robot"></i>
                Start Automation
            </button>
            <button class="btn btn-secondary" onclick="clearSelection()">
                <i class="fas fa-times"></i>
                Clear Selection
            </button>
            <button class="btn btn-warning" onclick="debugData()" style="margin-left: 10px;">
                <i class="fas fa-bug"></i>
                Debug Data
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Loading prior authorizations...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="fas fa-inbox"></i>
        <h3>No Prior Authorizations Found</h3>
        <p>There are no prior authorizations matching your current filters.</p>
    </div>
</div>

<!-- Prior Auth Detail Modal -->
<div class="modal" id="auth-detail-modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>Prior Authorization Details</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" id="modal-action-btn">Action</button>
        </div>
    </div>
</div>

<!-- Step Detail Modal -->
<div class="modal" id="step-detail-modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2 id="step-modal-title">Step Details</h2>
            <span class="close" onclick="closeStepModal()">&times;</span>
        </div>
        <div class="modal-body" id="step-modal-body">
            <!-- Step details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStepModal()">Close</button>
            <button class="btn btn-primary" id="step-modal-action-btn">Action</button>
        </div>
    </div>
</div>

<!-- Automation Workflow Popup -->
<div class="modal" id="automation-popup">
    <div class="modal-content automation-modal">
        <div class="modal-header">
            <h2><i class="fas fa-robot"></i> AI Agent Automation in Progress</h2>
            <span class="close" onclick="closeAutomationPopup()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="automation-container">
                <!-- Progress Bar -->
                <div class="automation-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="automation-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="automation-progress-text">0% Complete</div>
                </div>

                <!-- Step History Panel -->
                <div class="step-history-panel" id="step-history-panel">
                    <h4>Step History</h4>
                    <div class="step-history-container" id="step-history-container">
                        <!-- Completed steps will be added here -->
                    </div>
                </div>

                <!-- Current Step Display -->
                <div class="current-step-display">
                    <div class="step-header">
                        <div class="step-icon" id="current-step-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-info">
                            <h3 id="current-step-title">Step 1: Policy Research & Coverage Analysis</h3>
                            <p id="current-step-description">Searching web for insurance policy documents and determining coverage...</p>
                        </div>
                        <div class="step-status" id="current-step-status">
                            <i class="fas fa-spinner fa-spin"></i> Running
                        </div>
                    </div>
                </div>

                <!-- GPT-5 Search Animation -->
                <div class="gpt5-search-animation" id="gpt5-search-animation" style="display: none;">
                    <div class="search-container">
                        <div class="search-header">
                            <div class="search-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="search-text">
                                <h4>🔍 GPT Web Search in Progress</h4>
                                <p>Searching for insurance policy documents...</p>
                                <div class="search-dots">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="search-details">
                            <div class="search-query" id="current-search-query">Loading...</div>
                            <div class="search-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="search-progress-fill"></div>
                                </div>
                                <span class="progress-text" id="search-progress-text">0%</span>
                            </div>
                        </div>
                        
                        <!-- Real-time search results -->
                        <div class="live-search-results" id="live-search-results" style="display: none;">
                            <h5>📋 Live Search Results:</h5>
                            <div class="results-container" id="results-container">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Final analysis results -->
                        <div class="final-analysis" id="final-analysis" style="display: none;">
                            <h5>📊 Final Analysis:</h5>
                            <div class="analysis-container" id="analysis-container">
                                <!-- Analysis will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Completion Animation -->
                <div class="form-completion-animation" id="form-completion-animation" style="display: none;">
                    <div class="form-container">
                        <div class="form-icon">
                            <i class="fas fa-file-medical"></i>
                        </div>
                        <div class="form-text">
                            <h4>📝 Form Completion in Progress</h4>
                            <p>Filling form with EHR data and policy references...</p>
                            <div class="form-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                        </div>
                        <div class="form-details">
                            <div class="form-query" id="current-form-query">Loading...</div>
                            <div class="form-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="form-progress-fill"></div>
                                </div>
                                <span class="progress-text" id="form-progress-text">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step Content Area -->
                <div class="step-content-area">
                    <div class="content-container" id="step-content-container">
                        <!-- Content will be dynamically populated -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="automation-actions" id="automation-actions" style="display: none;">
                    <button class="btn btn-success" onclick="approveCurrentStep()">
                        <i class="fas fa-check"></i> Approve & Continue
                    </button>
                    <button class="btn btn-warning" onclick="requestChanges()">
                        <i class="fas fa-edit"></i> Request Changes
                    </button>
                    <button class="btn btn-info" onclick="sendToClinician()">
                        <i class="fas fa-user-md"></i> Send to Clinician
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clinician Message Modal -->
<div class="modal" id="clinician-message-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Message to Clinician</h2>
            <span class="close" onclick="closeClinicianModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="message-preview">
                <h4>Subject: Prior Authorization - Missing Information</h4>
                <div class="message-content" id="clinician-message-content">
                    <!-- Message content will be populated -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeClinicianModal()">Cancel</button>
            <button class="btn btn-primary" onclick="sendClinicianMessage()">
                <i class="fas fa-paper-plane"></i> Send via EPIC
            </button>
        </div>
    </div>
</div>

<!-- JavaScript moved to external file: static/js/dashboard.js -->
{% endblock %}
