{% extends "base.html" %}

{% block title %}AI Agent Prior Authorization Dashboard - Jarvus Demo{% endblock %}

{% block page_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% block content %}
<div class="work-queue-container">



    <!-- EPIC-style Action Bar -->
    <div class="epic-action-bar">
        <button class="epic-action-btn" onclick="loadData()" title="Refresh">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
        <button class="epic-action-btn" onclick="deferSelected()" title="Defer">
            <i class="fas fa-clock"></i>
            Defer
        </button>
        <button class="epic-action-btn" onclick="showFilterModal()" title="Filter">
            <i class="fas fa-filter"></i>
            Filter
        </button>
        <button class="epic-action-btn" onclick="addNotes()" title="Notes">
            <i class="fas fa-sticky-note"></i>
            Notes
        </button>
        <button class="epic-action-btn" onclick="editSelected()" title="Edit">
            <i class="fas fa-edit"></i>
            Edit
        </button>
        <button class="epic-action-btn" onclick="startAutomation()" title="Start Automation">
            <i class="fas fa-robot"></i>
            Start Auto
        </button>
        <button class="epic-action-btn" onclick="assignSelected()" title="Assign">
            <i class="fas fa-user-plus"></i>
            Assign
        </button>
        <button class="epic-action-btn" onclick="viewChart()" title="Chart">
            <i class="fas fa-chart-bar"></i>
            Chart
        </button>
        <button class="epic-action-btn" onclick="sendMessage()" title="In Basket Msg">
            <i class="fas fa-inbox"></i>
            In Basket Msg
        </button>
        <button class="epic-action-btn" onclick="newCall()" title="New Call">
            <i class="fas fa-phone"></i>
            New Call
        </button>
        <button class="epic-action-btn" onclick="showMore()" title="Show More">
            <i class="fas fa-chevron-down"></i>
            Show More
        </button>
        <button class="epic-action-btn" onclick="viewHistory()" title="WQ History">
            <i class="fas fa-calendar"></i>
            WQ History
        </button>
        <button class="epic-action-btn" onclick="resetAllCases()" title="Reset All Cases">
            <i class="fas fa-undo"></i>
            Reset All
        </button>
    </div>

    <!-- EPIC-style Tab Navigation -->
    <div class="epic-tab-navigation">
        <button class="epic-tab-button active" data-tab="all">
            Active (Total <span id="all-count">0</span>)
        </button>
        <button class="epic-tab-button" data-tab="deferred">
            Deferred (Total <span id="deferred-count">0</span>)
        </button>
        <button class="epic-tab-button" data-tab="completed">
            Completed (Total <span id="completed-tab-count">0</span>)
        </button>
    </div>

    <!-- EPIC-style Search and Filter Bar -->
    <div class="epic-filter-bar">
        <div class="epic-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search patients...">
        </div>
        <div class="epic-filter-controls">
            <select id="provider-filter" class="epic-select">
                <option value="">All Payers</option>
                <option value="Original Medicare">Original Medicare</option>
                <option value="Humana Medicare Advantage">Humana Medicare Advantage</option>
                <option value="UnitedHealthcare Medicare Advantage">UnitedHealthcare Medicare Advantage</option>
                <option value="Aetna Medicare Advantage">Aetna Medicare Advantage</option>
                <option value="Kaiser Medicare Advantage">Kaiser Medicare Advantage</option>
                <option value="Anthem Medicare Advantage">Anthem Medicare Advantage</option>
                <option value="Cigna Medicare Advantage">Cigna Medicare Advantage</option>
                <option value="Blue Cross Medicare Advantage">Blue Cross Medicare Advantage</option>
            </select>
            <select id="status-filter" class="epic-select">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="running">In Progress</option>
                <option value="review">Human Review</option>
                <option value="feedback">Needs Input</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="epic-status-info">
            <span class="status-text">Last refreshed: <span id="last-refreshed-time">Never</span></span>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulk-actions" style="display: none;">
        <div class="bulk-info">
            <span id="selected-count">0</span> items selected
        </div>
        <div class="bulk-buttons">
            <button class="btn btn-primary" onclick="startAutomation()">
                <i class="fas fa-robot"></i>
                Start Automation
            </button>
            <button class="btn btn-secondary" onclick="clearSelection()">
                <i class="fas fa-times"></i>
                Clear Selection
            </button>
            <button class="btn btn-warning" onclick="debugData()" style="margin-left: 10px;">
                <i class="fas fa-bug"></i>
                Debug Data
            </button>
        </div>
    </div>

    <!-- EPIC-style Work Queue Table -->
    <div class="epic-table-container">
        <table class="epic-table" id="prior-auth-table">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th class="patient-col sortable" data-sort="patient_name">
                        Patient Name <i class="fas fa-sort"></i>
                    </th>
                    <th class="created-col sortable" data-sort="created_date">
                        Created <i class="fas fa-sort"></i>
                    </th>
                    <th class="priority-col sortable" data-sort="clinical_urgency">
                        Priority <i class="fas fa-sort"></i>
                    </th>
                    <th class="type-col sortable" data-sort="service_type">
                        Type <i class="fas fa-sort"></i>
                    </th>
                    <th class="status-col sortable" data-sort="status">
                        Status <i class="fas fa-sort"></i>
                    </th>
                    <th class="ref-by-prov-col sortable" data-sort="ordering_provider">
                        Ref By Prov <i class="fas fa-sort"></i>
                    </th>
                    <th class="ref-by-dept-col sortable" data-sort="ordering_department">
                        Ref By Dept <i class="fas fa-sort"></i>
                    </th>
                    <th class="insurance-col sortable" data-sort="insurance_provider">
                        Insurance <i class="fas fa-sort"></i>
                    </th>
                    <th class="cpt-col sortable" data-sort="cpt_code">
                        CPT Code <i class="fas fa-sort"></i>
                    </th>
                    <th class="last-comm-date-col sortable" data-sort="last_updated">
                        Last Comm Date <i class="fas fa-sort"></i>
                    </th>
                    <th class="comm-outcome-col">
                        Comm Outcome
                    </th>
                    <th class="comm-comments-col">
                        Comm Cmnts
                    </th>
                </tr>
            </thead>
            <tbody id="prior-auth-tbody">
                <!-- Data will be loaded dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Loading prior authorizations...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <i class="fas fa-inbox"></i>
        <h3>No Prior Authorizations Found</h3>
        <p>There are no prior authorizations matching your current filters.</p>
    </div>
</div>

<!-- Prior Auth Detail Modal -->
<div class="modal" id="auth-detail-modal">
    <div class="modal-content epic-modal">
        <div class="modal-header">
            <h2 id="modal-title">Prior Authorization Details</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <!-- Tab Navigation -->
        <div class="modal-tabs">
            <button class="modal-tab active" data-tab="details" onclick="switchModalTab('details')">
                <i class="fas fa-info-circle"></i>
                Case Details
            </button>
            <button class="modal-tab" data-tab="automation" onclick="switchModalTab('automation')">
                <i class="fas fa-shield-alt"></i>
                Insurance Processing
            </button>
            <button class="modal-tab" data-tab="form-processing" onclick="switchModalTab('form-processing')">
                <i class="fas fa-file-medical"></i>
                Form Processing
            </button>
        </div>
        
        <!-- Tab Content -->
        <div class="modal-body">
            <!-- Details Tab -->
            <div class="tab-content active" id="details-tab">
                <div id="modal-body">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            
            <!-- Automation Tab -->
            <div class="tab-content" id="automation-tab">
                <div class="automation-container">
                    <!-- Progress Bar -->
                    <div class="automation-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="automation-progress-fill"></div>
                        </div>
                        <div class="progress-text" id="automation-progress-text">0% Complete</div>
                    </div>

                    <!-- Step History Panel -->
                    <div class="step-history-panel" id="step-history-panel">
                        <h4>Step History</h4>
                        <div class="step-history-container" id="step-history-container">
                            <!-- Completed steps will be added here -->
                        </div>
                    </div>

                    <!-- Current Step Display -->
                    <div class="current-step-display">
                        <div class="step-header">
                            <div class="step-icon" id="current-step-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="step-info">
                                <h3 id="current-step-title">Step 1: Policy Research & Coverage Analysis</h3>
                                <p id="current-step-description">Searching web for insurance policy documents and determining coverage...</p>
                            </div>
                            <div class="step-status" id="current-step-status">
                                <i class="fas fa-spinner fa-spin"></i> Running
                            </div>
                        </div>
                    </div>

                    <!-- Step Content Area -->
                    <div class="step-content-area">
                        <div class="content-container" id="step-content-container">
                            <!-- Content will be dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Processing Tab -->
            <div class="tab-content" id="form-processing-tab">
                <div class="form-processing-container">
                    <div class="form-header">
                        <h3>HUSKY Health Program Genetic Testing Prior Authorization Request Form</h3>
                        <!-- <p class="form-subtitle">All questions from the genetic testing form are shown below. The agent will populate answers in real-time as it processes each question.</p> -->
                        
                        <div class="processing-status">
                            <div class="progress-bar">
                                <div class="progress-fill" id="form-progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="status-text" id="form-status-text">Initializing question processor...</div>
                        </div>
                    </div>
                    
                    <div class="form-questions-container" id="form-questions-container">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="processing-summary" id="form-processing-summary">
                        <div class="summary-item">
                            <i class="fas fa-tasks"></i>
                            <span>Total Questions: <span id="total-questions">0</span></span>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-clock"></i>
                            <span>Processing Time: <span id="processing-time">Calculating...</span></span>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Completed: <span id="completed-questions">0</span>/<span id="total-questions-display">0</span></span>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Missing Data: <span id="missing-data">0</span></span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-primary" id="start-agent-btn" onclick="startFormAgentProcessing()">
                            <i class="fas fa-play"></i> Start Agent Processing
                        </button>
                        <button class="btn btn-success" id="save-form-btn" onclick="saveFormData()" style="display: none;">
                            <i class="fas fa-save"></i> Save Form Data
                        </button>
                        <button class="btn btn-info" id="export-form-btn" onclick="exportForm()" style="display: none;">
                            <i class="fas fa-file-pdf"></i> Download PDF Form
                        </button>
                        <button class="btn btn-outline-secondary" id="auto-scroll-toggle" onclick="toggleAutoScroll()" title="Toggle auto-scroll">
                            <i class="fas fa-arrow-down"></i> Auto-scroll
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-danger" id="modal-cancel-btn" style="display: none;" onclick="cancelAutomation()">Cancel Automation</button>
            <button class="btn btn-primary" id="modal-action-btn">Action</button>
        </div>
    </div>
</div>

<!-- Step Detail Modal -->
<div class="modal" id="step-detail-modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2 id="step-modal-title">Step Details</h2>
            <span class="close" onclick="closeStepModal()">&times;</span>
        </div>
        <div class="modal-body" id="step-modal-body">
            <!-- Step details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStepModal()">Close</button>
            <button class="btn btn-primary" id="step-modal-action-btn">Action</button>
        </div>
    </div>
</div>



<!-- Clinician Message Modal -->
<div class="modal" id="clinician-message-modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>Message to Clinician</h2>
            <span class="close" onclick="closeClinicianModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="message-editor">
                <div class="form-group">
                    <label for="clinician-message-subject">Subject:</label>
                    <input type="text" id="clinician-message-subject" class="form-control" value="Prior Authorization - Missing Information" placeholder="Enter subject...">
                </div>
                <div class="form-group">
                    <label for="clinician-message-body">Message:</label>
                    <textarea id="clinician-message-body" class="form-control" rows="12" placeholder="Enter your message to the clinician..."></textarea>
                </div>
                <div class="message-preview">
                    <h5>Preview:</h5>
                    <div class="preview-content" id="clinician-message-preview">
                        <!-- Preview will be updated as user types -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeClinicianModal()">Cancel</button>
            <button class="btn btn-info" onclick="previewClinicianMessage()">
                <i class="fas fa-eye"></i> Update Preview
            </button>
            <button class="btn btn-primary" onclick="sendClinicianMessage()">
                <i class="fas fa-paper-plane"></i> Send via EPIC
            </button>
        </div>
    </div>
</div>

<!-- JavaScript moved to external file: static/js/dashboard.js -->
{% endblock %}
